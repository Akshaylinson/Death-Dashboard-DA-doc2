<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Death Cases Analytics Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: 600;
        }
        
        .card {
            border: none;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            font-weight: 600;
        }
        
        .kpi-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
        }
        
        .kpi-card .card-title {
            font-size: 0.9rem;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .kpi-card h3 {
            margin: 0;
            font-weight: 700;
        }
        
        .bg-custom-primary { background: linear-gradient(45deg, #3498db, #2980b9); }
        .bg-custom-success { background: linear-gradient(45deg, #2ecc71, #27ae60); }
        .bg-custom-info { background: linear-gradient(45deg, #1abc9c, #16a085); }
        .bg-custom-warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .bg-custom-secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        
        .filter-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .chart-container {
            height: 400px;
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .badge {
            font-size: 0.7rem;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Death Cases Analytics Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="exportData()">Export</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar Filters -->
            <div class="col-lg-3">
                <div class="filter-section">
                    <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Data Filters</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <input type="date" class="form-control mb-2" id="startDate">
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">States</label>
                        <select class="form-select" id="stateSelect" multiple>
                            <!-- States will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="verifiedOnly">
                        <label class="form-check-label" for="verifiedOnly">
                            Verified Only
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Age Range</label>
                        <div class="row">
                            <div class="col">
                                <input type="number" class="form-control" id="minAge" placeholder="Min" min="0" max="100">
                            </div>
                            <div class="col">
                                <input type="number" class="form-control" id="maxAge" placeholder="Max" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100 mb-3" onclick="applyFilters()">
                        <i class="fas fa-sync-alt me-2"></i>Apply Filters
                    </button>
                    
                    <div class="text-center">
                        <small class="text-muted" id="recordCount">Loading data...</small>
                    </div>
                </div>
                
                <!-- Data Summary -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Data Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">Total States</small>
                                <strong id="totalStates">0</strong>
                            </div>
                            <div class="col-6 mb-3">
                                <small class="text-muted d-block">Date Range</small>
                                <strong id="dataRange">-</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Verification Rate</small>
                                <strong id="verificationRate">0%</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Data Quality</small>
                                <strong id="dataQuality">Good</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>
                
                <!-- KPI Cards -->
                <div class="row" id="kpiSection">
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="kpi-card bg-custom-primary">
                            <div class="card-title">Total Cases</div>
                            <h3 id="totalCases">0</h3>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="kpi-card bg-custom-success">
                            <div class="card-title">Verified</div>
                            <h3 id="verifiedCases">0</h3>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="kpi-card bg-custom-info">
                            <div class="card-title">States</div>
                            <h3 id="statesCount">0</h3>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="kpi-card bg-custom-warning">
                            <div class="card-title">Avg Age</div>
                            <h3 id="averageAge">0</h3>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="kpi-card bg-custom-secondary">
                            <div class="card-title">Daily Rate</div>
                            <h3 id="dailyRate">0</h3>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daily Death Rate Analysis</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleMovingAverage()">
                                        <i class="fas fa-chart-line me-1"></i>Toggle Moving Avg
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="dailyRateChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Cases by State</h5>
                            </div>
                            <div class="card-body">
                                <div id="stateDistributionChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Top Causes</h5>
                            </div>
                            <div class="card-body">
                                <div id="causesChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 3 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Age Distribution</h5>
                            </div>
                            <div class="card-body">
                                <div id="ageDistributionChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Monthly Trend</h5>
                            </div>
                            <div class="card-body">
                                <div id="monthlyTrendChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Case Records</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportData()">
                                <i class="fas fa-download me-1"></i>Export CSV
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleDataView()">
                                <i class="fas fa-table me-1"></i>Toggle View
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Date</th>
                                        <th>State</th>
                                        <th>District</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Cause</th>
                                        <th>Verified</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Details Modal -->
    <div class="modal fade" id="caseDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Case Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="caseDetailsContent">
                    <!-- Case details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentData = [];
        let allData = [];
        let showMovingAverage = true;
        let tableView = 'table'; // 'table' or 'cards'

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadData();
        });

        function initializeDates() {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        // Sample data - in a real application, this would come from an API
        function loadData() {
            showLoading(true);
            
            // Simulate API call delay
            setTimeout(() => {
                // Try to load from localStorage first, otherwise use sample data
                const savedData = localStorage.getItem('deathCasesData');
                
                if (savedData) {
                    allData = JSON.parse(savedData);
                } else {
                    // Generate sample data
                    allData = generateSampleData();
                    localStorage.setItem('deathCasesData', JSON.stringify(allData));
                }
                
                populateStateFilter();
                applyFilters();
                showLoading(false);
            }, 1000);
        }

        function generateSampleData() {
            const states = ['Telangana', 'Maharashtra', 'Karnataka', 'Tamil Nadu', 'Uttar Pradesh', 'Delhi'];
            const districts = {
                'Telangana': ['Hyderabad', 'Warangal', 'Khammam', 'Nizamabad'],
                'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Nashik'],
                'Karnataka': ['Bangalore', 'Mysore', 'Hubli', 'Mangalore'],
                'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Trichy'],
                'Uttar Pradesh': ['Lucknow', 'Kanpur', 'Varanasi', 'Agra'],
                'Delhi': ['New Delhi', 'Central Delhi', 'East Delhi', 'North Delhi']
            };
            const causes = ['drowning', 'road accident', 'heart attack', 'COVID-19', 'suicide', 'other'];
            const genders = ['Male', 'Female'];
            
            const data = [];
            const startDate = new Date(2024, 0, 1); // Jan 1, 2024
            const endDate = new Date();
            
            for (let i = 0; i < 500; i++) {
                const randomState = states[Math.floor(Math.random() * states.length)];
                const randomDistrict = districts[randomState][Math.floor(Math.random() * districts[randomState].length)];
                
                // Random date between start and end
                const randomDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime()));
                
                data.push({
                    case_id: `TG-D-${20240001 + i}`,
                    reported_date: randomDate.toISOString().split('T')[0],
                    state: randomState,
                    district: randomDistrict,
                    gender: genders[Math.floor(Math.random() * genders.length)],
                    age: Math.floor(Math.random() * 80) + 10,
                    cause_of_death: causes[Math.floor(Math.random() * causes.length)],
                    reason_or_context: 'Sample context for case ' + i,
                    source_name: 'NEWS_SOURCE_' + (i % 5),
                    source_url: 'https://example.com/case/' + i,
                    verified: Math.random() > 0.3
                });
            }
            
            return data;
        }

        function populateStateFilter() {
            const stateSelect = document.getElementById('stateSelect');
            const states = [...new Set(allData.map(item => item.state))].sort();
            
            stateSelect.innerHTML = '';
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                option.selected = true;
                stateSelect.appendChild(option);
            });
        }

        function applyFilters() {
            showLoading(true);
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const selectedStates = Array.from(document.getElementById('stateSelect').selectedOptions).map(opt => opt.value);
            const verifiedOnly = document.getElementById('verifiedOnly').checked;
            const minAge = document.getElementById('minAge').value;
            const maxAge = document.getElementById('maxAge').value;
            
            // Apply filters
            currentData = allData.filter(item => {
                // Date filter
                if (startDate && item.reported_date < startDate) return false;
                if (endDate && item.reported_date > endDate) return false;
                
                // State filter
                if (selectedStates.length > 0 && !selectedStates.includes(item.state)) return false;
                
                // Verified filter
                if (verifiedOnly && !item.verified) return false;
                
                // Age filter
                if (minAge && item.age < parseInt(minAge)) return false;
                if (maxAge && item.age > parseInt(maxAge)) return false;
                
                return true;
            });
            
            updateKPIs();
            updateDataTable();
            updateCharts();
            updateDataSummary();
            
            showLoading(false);
        }

        function updateKPIs() {
            document.getElementById('totalCases').textContent = currentData.length.toLocaleString();
            
            const verifiedCount = currentData.filter(item => item.verified).length;
            document.getElementById('verifiedCases').textContent = verifiedCount.toLocaleString();
            
            const statesCount = new Set(currentData.map(item => item.state)).size;
            document.getElementById('statesCount').textContent = statesCount;
            
            const totalAge = currentData.reduce((sum, item) => sum + item.age, 0);
            const avgAge = currentData.length > 0 ? (totalAge / currentData.length).toFixed(1) : 0;
            document.getElementById('averageAge').textContent = avgAge;
            
            // Calculate daily rate
            if (currentData.length > 0) {
                const dates = currentData.map(item => new Date(item.reported_date));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                const dayDiff = (maxDate - minDate) / (1000 * 60 * 60 * 24) + 1;
                const dailyRate = (currentData.length / dayDiff).toFixed(1);
                document.getElementById('dailyRate').textContent = dailyRate;
            } else {
                document.getElementById('dailyRate').textContent = '0';
            }
            
            document.getElementById('recordCount').textContent = 
                `${currentData.length.toLocaleString()} records match your filters`;
        }

        function updateDataSummary() {
            const totalStates = new Set(allData.map(item => item.state)).size;
            document.getElementById('totalStates').textContent = totalStates;
            
            if (allData.length > 0) {
                const dates = allData.map(item => new Date(item.reported_date));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('dataRange').textContent = 
                    `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}`;
            }
            
            const verifiedCount = allData.filter(item => item.verified).length;
            const verificationRate = ((verifiedCount / allData.length) * 100).toFixed(1);
            document.getElementById('verificationRate').textContent = `${verificationRate}%`;
            
            // Simple data quality check
            const completeRecords = allData.filter(item => 
                item.case_id && item.reported_date && item.state && item.age
            ).length;
            const qualityPercent = ((completeRecords / allData.length) * 100).toFixed(0);
            document.getElementById('dataQuality').textContent = 
                qualityPercent >= 90 ? 'Good' : qualityPercent >= 70 ? 'Fair' : 'Poor';
        }

        function updateDataTable() {
            const tbody = document.querySelector('#dataTable tbody');
            
            if (tableView === 'table') {
                tbody.innerHTML = '';
                
                currentData.slice(0, 100).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.case_id || '-'}</td>
                        <td>${item.reported_date ? new Date(item.reported_date).toLocaleDateString() : '-'}</td>
                        <td>${item.state || '-'}</td>
                        <td>${item.district || '-'}</td>
                        <td>${item.age || '-'}</td>
                        <td>${item.gender || '-'}</td>
                        <td>${item.cause_of_death || '-'}</td>
                        <td>${item.verified ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-warning">No</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewCaseDetails('${item.case_id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                // Card view implementation would go here
            }
        }

        function toggleDataView() {
            tableView = tableView === 'table' ? 'cards' : 'table';
            updateDataTable();
        }

        function updateCharts() {
            updateDailyRateChart();
            updateStateDistributionChart();
            updateCausesChart();
            updateAgeDistributionChart();
            updateMonthlyTrendChart();
        }

        function updateDailyRateChart() {
            if (currentData.length === 0) {
                document.getElementById('dailyRateChart').innerHTML = '<p class="text-center text-muted">No data available</p>';
                return;
            }
            
            // Group by date
            const dateCounts = {};
            currentData.forEach(item => {
                const date = item.reported_date;
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });
            
            // Convert to arrays for plotting
            const dates = Object.keys(dateCounts).sort();
            const counts = dates.map(date => dateCounts[date]);
            
            // Calculate 7-day moving average
            const movingAvg = [];
            for (let i = 0; i < counts.length; i++) {
                const start = Math.max(0, i - 6);
                const end = i + 1;
                const window = counts.slice(start, end);
                const avg = window.reduce((a, b) => a + b, 0) / window.length;
                movingAvg.push(avg);
            }
            
            const trace1 = {
                x: dates,
                y: counts,
                type: 'bar',
                name: 'Daily Cases',
                marker: { color: 'lightcoral' }
            };
            
            const trace2 = {
                x: dates,
                y: movingAvg,
                type: 'scatter',
                mode: 'lines',
                name: '7-Day Moving Avg',
                line: { color: 'blue', width: 3 }
            };
            
            const data = showMovingAverage ? [trace1, trace2] : [trace1];
            
            const layout = {
                title: 'Daily Death Cases',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Number of Cases' },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('dailyRateChart', data, layout, { responsive: true });
        }

        function updateStateDistributionChart() {
            if (currentData.length === 0) {
                document.getElementById('stateDistributionChart').innerHTML = '<p class="text-center text-muted">No data available</p>';
                return;
            }
            
            // Count by state
            const stateCounts = {};
            currentData.forEach(item => {
                stateCounts[item.state] = (stateCounts[item.state] || 0) + 1;
            });
            
            const states = Object.keys(stateCounts);
            const counts = states.map(state => stateCounts[state]);
            
            const data = [{
                x: states,
                y: counts,
                type: 'bar',
                marker: {
                    color: counts,
                    colorscale: 'Viridis'
                }
            }];
            
            const layout = {
                title: 'Cases by State',
                xaxis: { title: 'State' },
                yaxis: { title: 'Number of Cases' }
            };
            
            Plotly.newPlot('stateDistributionChart', data, layout, { responsive: true });
        }

        function updateCausesChart() {
            if (currentData.length === 0) {
                document.getElementById('causesChart').innerHTML = '<p class="text-center text-muted">No data available</p>';
                return;
            }
            
            // Count by cause
            const causeCounts = {};
            currentData.forEach(item => {
                causeCounts[item.cause_of_death] = (causeCounts[item.cause_of_death] || 0) + 1;
            });
            
            const causes = Object.keys(causeCounts);
            const counts = causes.map(cause => causeCounts[cause]);
            
            // Take top 10 causes
            const combined = causes.map((cause, i) => ({ cause, count: counts[i] }));
            combined.sort((a, b) => b.count - a.count);
            const topCauses = combined.slice(0, 10);
            
            const data = [{
                values: topCauses.map(item => item.count),
                labels: topCauses.map(item => item.cause),
                type: 'pie',
                hole: 0.4,
                textinfo: 'label+percent'
            }];
            
            const layout = {
                title: 'Top 10 Causes of Death',
                showlegend: false
            };
            
            Plotly.newPlot('causesChart', data, layout, { responsive: true });
        }

        function updateAgeDistributionChart() {
            if (currentData.length === 0) {
                document.getElementById('ageDistributionChart').innerHTML = '<p class="text-center text-muted">No data available</p>';
                return;
            }
            
            const ages = currentData.map(item => item.age).filter(age => age);
            
            const data = [{
                x: ages,
                type: 'histogram',
                nbinsx: 20,
                marker: {
                    color: 'lightseagreen'
                }
            }];
            
            const layout = {
                title: 'Age Distribution',
                xaxis: { title: 'Age' },
                yaxis: { title: 'Frequency' }
            };
            
            Plotly.newPlot('ageDistributionChart', data, layout, { responsive: true });
        }

        function updateMonthlyTrendChart() {
            if (currentData.length === 0) {
                document.getElementById('monthlyTrendChart').innerHTML = '<p class="text-center text-muted">No data available</p>';
                return;
            }
            
            // Group by month
            const monthCounts = {};
            currentData.forEach(item => {
                const date = new Date(item.reported_date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthCounts[monthYear] = (monthCounts[monthYear] || 0) + 1;
            });
            
            const months = Object.keys(monthCounts).sort();
            const counts = months.map(month => monthCounts[month]);
            
            const data = [{
                x: months,
                y: counts,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: 'orange', width: 3 },
                marker: { size: 8 }
            }];
            
            const layout = {
                title: 'Monthly Trend',
                xaxis: { title: 'Month' },
                yaxis: { title: 'Number of Cases' }
            };
            
            Plotly.newPlot('monthlyTrendChart', data, layout, { responsive: true });
        }

        function toggleMovingAverage() {
            showMovingAverage = !showMovingAverage;
            updateDailyRateChart();
        }

        function viewCaseDetails(caseId) {
            const caseData = currentData.find(item => item.case_id === caseId);
            if (!caseData) return;
            
            const modalContent = document.getElementById('caseDetailsContent');
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <p><strong>Case ID:</strong> ${caseData.case_id}</p>
                        <p><strong>Reported Date:</strong> ${new Date(caseData.reported_date).toLocaleDateString()}</p>
                        <p><strong>Location:</strong> ${caseData.district}, ${caseData.state}</p>
                        <p><strong>Age / Gender:</strong> ${caseData.age} / ${caseData.gender}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Case Details</h6>
                        <p><strong>Cause of Death:</strong> ${caseData.cause_of_death}</p>
                        <p><strong>Verified:</strong> ${caseData.verified ? 'Yes' : 'No'}</p>
                        <p><strong>Context:</strong> ${caseData.reason_or_context}</p>
                        <p><strong>Source:</strong> ${caseData.source_name}</p>
                        ${caseData.source_url ? `<p><strong>Source URL:</strong> <a href="${caseData.source_url}" target="_blank">${caseData.source_url}</a></p>` : ''}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('caseDetailsModal'));
            modal.show();
        }

        function exportData() {
            if (currentData.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Convert to CSV
            const headers = Object.keys(currentData[0]);
            const csvContent = [
                headers.join(','),
                ...currentData.map(row => 
                    headers.map(header => 
                        JSON.stringify(row[header] || '')
                    ).join(',')
                )
            ].join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `death_cases_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('kpiSection').style.display = show ? 'none' : 'block';
        }
    </script>
</body>
</html>
